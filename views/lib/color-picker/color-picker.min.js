(function ($, undefined) {

    var templateToggle   = '<a tabindex="0" class="wp-color-result" />';
    var templateHolder   = '<div class="wp-picker-holder" />';
    var templateWrap     = '<div class="wp-picker-container" />';
    var templateButton   = '<input type="button" class="button button-small hidden" />';

    var widget = {

        options: {
            defaultColor: false,
            change: false,
            clear: false,
            hide: true,
            palettes: true,
            width: 255,
            mode: "hsv"
        },

        _create: function () {

            if (!$.support.iris) {
                return;
            }

            var self = this;
            var input = self.element;

            $.extend(self.options, input.data());
            self.close = $.proxy(self.close, self);

            self.initialValue = input.val();

            input
                .addClass("wp-color-picker")
                .hide()
                .wrap(templateWrap);

            self.wrap = input.parent();

            self.toggler = $(templateToggle)
                .insertBefore(input)
                .css({ backgroundColor: self.initialValue })
                .attr("title", wpColorPickerL10n.pick)
                .attr("data-current", wpColorPickerL10n.current);

            self.pickerContainer = $(templateHolder).insertAfter(input);

            self.button = $(templateButton);

            if (self.options.defaultColor) {
                self.button
                    .addClass("wp-picker-default")
                    .val(wpColorPickerL10n.defaultString);
            } else {
                self.button
                    .addClass("wp-picker-clear")
                    .val(wpColorPickerL10n.clear);
            }

            input
                .wrap('<span class="wp-picker-input-wrap" />')
                .after(self.button);

            input.iris({
                target: self.pickerContainer,
                hide: self.options.hide,
                width: self.options.width,
                mode: self.options.mode,
                palettes: self.options.palettes,
                change: function (event, ui) {
                    self.toggler.css({ backgroundColor: ui.color.toString() });
                    if ($.isFunction(self.options.change)) {
                        self.options.change.call(this, event, ui);
                    }
                }
            });

            input.val(self.initialValue);

            self._addListeners();

            if (!self.options.hide) {
                self.toggler.click();
            }
        },

        _addListeners: function () {
            var self = this;

            self.wrap.on("click.wpcolorpicker", function (event) {
                event.stopPropagation();
            });

            self.toggler.click(function () {
                if (self.toggler.hasClass("wp-picker-open")) {
                    self.close();
                } else {
                    self.open();
                }
            });

            self.element.change(function (event) {
                var value = $(this).val();
                if (value === "" || value === "#") {
                    self.toggler.css("backgroundColor", "");
                    if ($.isFunction(self.options.clear)) {
                        self.options.clear.call(this, event);
                    }
                }
            });

            self.toggler.on("keyup", function (event) {
                if (event.keyCode === 13 || event.keyCode === 32) {
                    event.preventDefault();
                    self.toggler.trigger("click").next().focus();
                }
            });

            self.button.click(function (event) {
                var btn = $(this);

                if (btn.hasClass("wp-picker-clear")) {

                    self.element.val("");
                    self.toggler.css("backgroundColor", "");

                    if ($.isFunction(self.options.clear)) {
                        self.options.clear.call(this, event);
                    }

                } else if (btn.hasClass("wp-picker-default")) {

                    self.element
                        .val(self.options.defaultColor)
                        .change();

                }
            });
        },

        open: function () {
            this.element.show().iris("toggle").focus();
            this.button.removeClass("hidden");
            this.wrap.addClass("wp-picker-active");
            this.toggler.addClass("wp-picker-open");

            $("body")
                .trigger("click.wpcolorpicker")
                .on("click.wpcolorpicker", this.close);
        },

        close: function () {
            this.element.hide().iris("toggle");
            this.button.addClass("hidden");
            this.wrap.removeClass("wp-picker-active");
            this.toggler.removeClass("wp-picker-open");

            $("body")
                .off("click.wpcolorpicker", this.close);
        },

        color: function (val) {
            if (val === undefined) {
                return this.element.iris("option", "color");
            }
            this.element.iris("option", "color", val);
        },

        defaultColor: function (val) {
            if (val === undefined) {
                return this.options.defaultColor;
            }
            this.options.defaultColor = val;
        }

    };

    $.widget("wp.wpColorPicker", widget);

})(jQuery);